-- ==========================================
-- E-SMART DATABASE SCHEMA (SAFETY MODE)
-- Author: Tim Developer E-Smart
-- Updated: 2025 (Revisi No-Cascade for Products)
-- ==========================================

DROP DATABASE IF EXISTS esmart_db;
CREATE DATABASE esmart_db;
USE esmart_db;

-- ==========================================
-- 1. TABEL MASTER
-- ==========================================

CREATE TABLE users (
    id_user INT AUTO_INCREMENT PRIMARY KEY,
    nis VARCHAR(20) UNIQUE NULL,
    nama VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role ENUM('admin', 'petugas', 'siswa') DEFAULT 'siswa',
    kelas VARCHAR(20) NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE kategori_barang (
    id_kategori INT AUTO_INCREMENT PRIMARY KEY,
    nama_kategori VARCHAR(50) NOT NULL,
    deskripsi TEXT
);

-- ==========================================
-- 2. TABEL BARANG & INVENTORY
-- ==========================================

CREATE TABLE barang (
    id_barang INT AUTO_INCREMENT PRIMARY KEY,
    id_kategori INT NOT NULL,
    nama_barang VARCHAR(100) NOT NULL,
    harga INT NOT NULL,
    stok INT DEFAULT 0,
    satuan VARCHAR(20) DEFAULT 'pcs',
    gambar VARCHAR(255),
    -- KITA KUNCI: Kategori gabisa dihapus kalau masih ada Barangnya
    FOREIGN KEY (id_kategori) REFERENCES kategori_barang(id_kategori)
        ON DELETE RESTRICT ON UPDATE CASCADE
);

CREATE TABLE stok_barang (
    id_stok INT AUTO_INCREMENT PRIMARY KEY,
    id_barang INT NOT NULL,
    jumlah INT NOT NULL,
    kondisi ENUM('baik', 'rusak', 'kadaluarsa') DEFAULT 'baik',
    tanggal DATETIME DEFAULT CURRENT_TIMESTAMP,
    keterangan TEXT,
    -- KITA KUNCI: Barang gabisa dihapus kalau masih ada History Stok-nya
    FOREIGN KEY (id_barang) REFERENCES barang(id_barang)
        ON DELETE RESTRICT ON UPDATE CASCADE
);

-- ==========================================
-- 3. TABEL TRANSAKSI
-- ==========================================

CREATE TABLE keranjang (
    id_keranjang INT AUTO_INCREMENT PRIMARY KEY,
    id_user INT NOT NULL,
    id_barang INT NOT NULL,
    jumlah INT NOT NULL DEFAULT 1,
    -- User dihapus -> Keranjang user itu hilang (Ini Wajar/Aman)
    FOREIGN KEY (id_user) REFERENCES users(id_user) ON DELETE CASCADE,
    -- KITA KUNCI: Barang gabisa dihapus kalau lagi ada di Keranjang User
    FOREIGN KEY (id_barang) REFERENCES barang(id_barang) ON DELETE RESTRICT
);

CREATE TABLE transaksi (
    id_transaksi INT AUTO_INCREMENT PRIMARY KEY,
    id_user INT NOT NULL,
    tanggal DATETIME DEFAULT CURRENT_TIMESTAMP,
    total_harga INT NOT NULL,
    status ENUM('pending', 'dibayar', 'selesai', 'batal') DEFAULT 'pending',
    -- User dihapus -> Transaksi JANGAN hilang (Data Keuangan)
    FOREIGN KEY (id_user) REFERENCES users(id_user) ON DELETE RESTRICT
);

CREATE TABLE detail_transaksi (
    id_detail INT AUTO_INCREMENT PRIMARY KEY,
    id_transaksi INT NOT NULL,
    id_barang INT NOT NULL,
    jumlah INT NOT NULL,
    harga_satuan INT NOT NULL,
    subtotal INT NOT NULL,
    -- Khusus ini WAJIB Cascade: Kalau Nota Header dihapus, Rinciannya harus hilang
    FOREIGN KEY (id_transaksi) REFERENCES transaksi(id_transaksi) ON DELETE CASCADE,
    -- KITA KUNCI: Barang gabisa dihapus kalau pernah ada transaksi
    FOREIGN KEY (id_barang) REFERENCES barang(id_barang) ON DELETE RESTRICT
);